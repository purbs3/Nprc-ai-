var P=Object.defineProperty;var U=(a,t,u)=>t in a?P(a,t,{enumerable:!0,configurable:!0,writable:!0,value:u}):a[t]=u;var b=(a,t,u)=>U(a,typeof t!="symbol"?t+"":t,u);import{r as d,j as e}from"./index-DIzydVhA.js";import{c as Y,a as K}from"./geminiService-D3ylRyWO.js";import{H as R,V as O,b as F,L as z,c as B,d as V}from"./IconComponents-CQvE_25E.js";function J(a){const t=atob(a),u=t.length,r=new Uint8Array(u);for(let l=0;l<u;l++)r[l]=t.charCodeAt(l);return r}async function q(a,t,u,r){const l=new Int16Array(a.buffer),c=l.length/r,i=t.createBuffer(r,c,u);for(let h=0;h<r;h++){const f=i.getChannelData(h);for(let g=0;g<c;g++)f[g]=l[g*r+h]/32768}return i}class G{constructor(){b(this,"audioContext",null);b(this,"source",null);b(this,"listeners",new Set);b(this,"currentMessageId",null);b(this,"status","idle");b(this,"error")}initializeAudioContext(){var t;if(!this.audioContext||this.audioContext.state==="closed")try{this.audioContext=new(window.AudioContext||window.webkitAudioContext)({sampleRate:24e3})}catch(u){console.error("Web Audio API is not supported in this browser.",u),this.status="error",this.error="Audio playback is not supported on this device.",this.notifyListeners()}((t=this.audioContext)==null?void 0:t.state)==="suspended"&&this.audioContext.resume()}notifyListeners(){this.listeners.forEach(t=>t({status:this.status,messageId:this.currentMessageId,error:this.error}))}subscribe(t){return this.listeners.add(t),t({status:this.status,messageId:this.currentMessageId,error:this.error}),()=>this.unsubscribe(t)}unsubscribe(t){this.listeners.delete(t)}async play(t,u){if(this.status==="playing"&&this.currentMessageId===t){this.stop();return}if(this.stop(),this.initializeAudioContext(),!!this.audioContext){this.currentMessageId=t,this.status="loading",this.error=void 0,this.notifyListeners();try{const r=await Y(u),l=J(r),c=await q(l,this.audioContext,24e3,1),i=this.audioContext.createBufferSource();i.buffer=c,i.connect(this.audioContext.destination),i.onended=()=>{this.currentMessageId===t&&(this.status="idle",this.currentMessageId=null,this.notifyListeners())},this.source=i,this.source.start(),this.status="playing",this.notifyListeners()}catch(r){console.error("Audio generation failed:",r),this.status="error",this.error="Could not play audio.",this.notifyListeners()}}}stop(){this.source&&(this.source.onended=null,this.source.stop(),this.source=null),this.status="idle",this.currentMessageId=null,this.notifyListeners()}}const E=new G,W=a=>a?a.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/__(.*?)__/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/_(.*?)_/g,"<em>$1</em>").replace(/\n/g,"<br />"):"",Q=({message:a})=>{const{id:t,role:u,content:r,imageUrls:l}=a,c=u==="model",[i,h]=d.useState({status:"idle",messageId:null});d.useEffect(()=>{const y=E.subscribe(h);return()=>y()},[]);const f=i.messageId===t&&i.status==="playing",g=i.messageId===t&&i.status==="loading",I=()=>{r&&E.play(t,r)},N=()=>({__html:W(r)});return c&&r===""?e.jsxs("div",{className:"flex items-start gap-4 animate-fadeIn",children:[e.jsx("div",{className:"flex-shrink-0 h-8 w-8 rounded-full bg-slate-700 flex items-center justify-center",children:e.jsx(R,{className:"h-5 w-5 text-cyan-400"})}),e.jsx("div",{className:"flex items-center justify-center bg-slate-800 text-slate-300 px-4 py-3 rounded-lg rounded-tl-none max-w-2xl",children:e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-cyan-400"})})]}):e.jsxs("div",{className:`flex items-start gap-4 ${c?"":"justify-end"} animate-fadeIn`,children:[c&&e.jsx("div",{className:"flex-shrink-0 h-8 w-8 rounded-full bg-slate-700 flex items-center justify-center",children:e.jsx(R,{className:"h-5 w-5 text-cyan-400"})}),e.jsxs("div",{className:`text-slate-300 px-4 py-3 rounded-lg max-w-2xl prose prose-invert prose-p:my-0 prose-ul:my-0 prose-ol:my-0 prose-li:my-1 relative group ${c?"bg-slate-800 rounded-tl-none":"bg-cyan-600/50 text-white rounded-br-none"}`,children:[l&&l.length>0&&e.jsx("div",{className:`grid gap-2 mb-2 ${l.length>1?"grid-cols-2":"grid-cols-1"}`,children:l.map((y,w)=>e.jsx("img",{src:y,alt:`User upload ${w+1}`,className:"w-full h-auto rounded-lg"},w))}),e.jsx("div",{dangerouslySetInnerHTML:N()}),c&&r&&e.jsx("button",{onClick:I,className:`absolute -bottom-4 -right-4 h-8 w-8 rounded-full flex items-center justify-center transition-all opacity-0 group-hover:opacity-100 disabled:opacity-50 ${f?"bg-red-500 text-white":"bg-slate-700 text-cyan-400 hover:bg-slate-600"}`,"aria-label":f?"Stop audio":"Play audio",disabled:g,children:g?e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white"}):e.jsx(O,{className:"h-5 w-5"})}),i.messageId===t&&i.status==="error"&&e.jsx("p",{className:"text-red-400 text-xs mt-1",children:i.error})]})]})},X="nprc-chat-history-user",Z="nprc-chat-history-clinician",ne=({userType:a})=>{const t=a==="user"?X:Z,u=()=>{let s=[];try{const n=localStorage.getItem(t);n&&(s=JSON.parse(n))}catch(n){console.error("Failed to load chat history:",n)}if(s.length===0){const n=a==="user"?"Hello! I am your AI assistant from NPRC Physiotherapy. How can I help you with your muscle or joint concerns today? You can start a guided check-up using the button below.":"Hello! I am your AI clinical assistant. You can ask me about differential diagnoses, treatment protocols, or recent research. How can I assist you?";return[{id:`initial-${Date.now()}`,role:"model",content:n}]}return s},[r,l]=d.useState(u),[c,i]=d.useState(""),[h,f]=d.useState(!1),[g,I]=d.useState(!1),[N,y]=d.useState(null),[w,$]=d.useState(!1),m=d.useRef(null),M=d.useRef(""),k=d.useRef(null),A=d.useRef(null);d.useEffect(()=>{const s=window.SpeechRecognition||window.webkitSpeechRecognition;if(!s){y("Speech recognition is not supported in this browser.");return}const n=new s;return n.continuous=!0,n.interimResults=!0,n.lang="en-US",n.onstart=()=>I(!0),n.onend=()=>I(!1),n.onerror=o=>{y(`An error occurred: ${o.error}. Please check permissions.`),I(!1)},n.onresult=o=>{const p=Array.from(o.results).map(j=>j[0].transcript).join("");i(M.current+p)},m.current=n,()=>{var o;return(o=m.current)==null?void 0:o.stop()}},[]),d.useEffect(()=>{var s;(s=k.current)==null||s.scrollIntoView({behavior:"smooth"})},[r]),d.useEffect(()=>{localStorage.setItem(t,JSON.stringify(r))},[r,t]),d.useEffect(()=>{const s=A.current;s&&(s.style.height="auto",s.style.height=`${Math.min(s.scrollHeight,200)}px`)},[c]);const _=()=>{const s="Sorry, the AI service is not available. Please try again later.";l(n=>{const o=[...n];return o.length>0&&o[o.length-1].role==="model"&&o[o.length-1].content===""?o[o.length-1].content=s:o.push({id:`model-error-${Date.now()}`,role:"model",content:s}),o})},L=async(s,n)=>{l(o=>[...o,n,{id:`model-${Date.now()}`,role:"model",content:""}]),i("");try{const o=await K({history:s,isThinkingMode:w,type:a==="user"?"user":"clinician_chat"});let p="";for await(const j of o){const S=j.text;S&&(p+=S,l(x=>{const C=[...x];return C[C.length-1].content=p,C}))}}catch(o){console.error("AI chat stream error:",o),_()}finally{f(!1)}},v=async s=>{var S;const n=s.trim();if(!n||h)return;g&&((S=m.current)==null||S.stop()),f(!0);const p=r.slice(-15).filter(x=>x&&x.content).map(x=>({role:x.role,parts:[{text:x.content}]})),j={id:`user-${Date.now()}`,role:"user",content:n};p.push({role:"user",parts:[{text:n}]}),await L(p,j)},D=s=>{s.preventDefault(),v(c)},H=()=>{m.current&&(g?m.current.stop():(M.current=c.trim()?c.trim()+" ":"",m.current.start()))},T=a==="user"?"Describe your symptoms...":"Ask a clinical question...";return e.jsx(e.Fragment,{children:e.jsxs("section",{className:"bg-slate-900 flex flex-col h-full",children:[e.jsxs("div",{className:"flex-1 p-6 space-y-6 overflow-y-auto",children:[r.map(s=>e.jsx(Q,{message:s},s.id)),e.jsx("div",{ref:k})]}),e.jsxs("div",{className:"p-4 border-t border-slate-700 bg-slate-800/50 rounded-b-xl",children:[e.jsxs("form",{onSubmit:D,className:"flex items-end gap-2",children:[a==="user"&&e.jsxs("button",{type:"button",onClick:()=>v("I'd like to start a guided symptom check."),className:"p-2 rounded-lg bg-slate-600 text-slate-200 hover:bg-slate-500 transition-colors disabled:opacity-50 h-full flex flex-col justify-center items-center text-center",disabled:h,"aria-label":"Start guided symptom check",title:"Start Guided Symptom Check",children:[e.jsx(F,{className:"h-5 w-5"}),e.jsx("span",{className:"text-xs mt-1",children:"Check"})]}),e.jsx("textarea",{ref:A,value:c,onChange:s=>i(s.target.value),onKeyDown:s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),v(c))},rows:1,placeholder:T,className:"flex-1 bg-slate-700 text-slate-200 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-500 transition-colors resize-none overflow-hidden self-stretch",disabled:h}),e.jsxs("div",{className:"flex flex-col gap-1 self-stretch",children:[e.jsx("button",{type:"button",onClick:()=>$(s=>!s),className:`p-2 rounded-lg transition-colors disabled:opacity-50 flex-1 ${w?"bg-cyan-500 text-white":"bg-slate-600 text-slate-200 hover:bg-slate-500"}`,disabled:h,title:w?"Thinking Mode is ON":"Enable Thinking Mode",children:e.jsx(z,{className:"h-5 w-5"})}),m.current&&e.jsx("button",{type:"button",onClick:H,className:`p-2 rounded-lg transition-colors disabled:opacity-50 flex-1 ${g?"bg-red-500 text-white animate-pulse":"bg-slate-600 text-slate-200 hover:bg-slate-500"}`,disabled:h,"aria-label":g?"Stop recording":"Start recording",children:e.jsx(B,{className:"h-5 w-5"})})]}),e.jsx("button",{type:"submit",className:"bg-cyan-500 text-white p-3 rounded-lg hover:bg-cyan-400 transition-colors disabled:bg-slate-600 self-stretch flex items-center w-14 justify-center",disabled:h||!c.trim(),"aria-label":"Send message",children:h?e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-white"}):e.jsx(V,{className:"h-6 w-6"})})]}),N&&e.jsx("p",{className:"text-red-400 text-xs text-center mt-2",children:N})]})]})})};export{ne as C};
